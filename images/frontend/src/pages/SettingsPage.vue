<template>
  <div class="settings-page">
    <div class="settings-header">
      <h1>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–∞</h1>
      <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∞—à–∏–º–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</p>
    </div>

    <div class="settings-content">
      <!-- –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å -->
      <div class="settings-section">
        <h2>–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å</h2>
        <div class="settings-cards">
          <router-link to="/change-email" class="settings-card">
            <div class="card-icon">üìß</div>
            <div class="card-content">
              <h3>–ò–∑–º–µ–Ω–∏—Ç—å email</h3>
              <p>–û–±–Ω–æ–≤–∏—Ç–µ –≤–∞—à –∞–¥—Ä–µ—Å —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–π –ø–æ—á—Ç—ã</p>
            </div>
            <div class="card-arrow">‚Üí</div>
          </router-link>

          <router-link to="/change-password" class="settings-card">
            <div class="card-icon">üîí</div>
            <div class="card-content">
              <h3>–ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</h3>
              <p>–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –¥–ª—è –≤–∞—à–µ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞</p>
            </div>
            <div class="card-arrow">‚Üí</div>
          </router-link>

          <router-link to="/sessions" class="settings-card">
            <div class="card-icon">üíª</div>
            <div class="card-content">
              <h3>–ê–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏</h3>
              <p>
                –ü—Ä–æ—Å–º–æ—Ç—Ä –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏, –Ω–∞ –∫–æ—Ç–æ—Ä—ã—Ö –≤—ã–ø–æ–ª–Ω–µ–Ω –≤—Ö–æ–¥
              </p>
            </div>
            <div class="card-arrow">‚Üí</div>
          </router-link>
        </div>
      </div>

      <!-- –î–µ–π—Å—Ç–≤–∏—è -->
      <div class="settings-section">
        <h2>–î–µ–π—Å—Ç–≤–∏—è</h2>
        <div class="settings-cards">
          <button
            @click="handleSignOut"
            :disabled="signOutLoading"
            class="settings-card danger"
          >
            <div class="card-icon">üö™</div>
            <div class="card-content">
              <h3>–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</h3>
              <p>–ó–∞–≤–µ—Ä—à–∏—Ç–µ —Ç–µ–∫—É—â—É—é —Å–µ—Å—Å–∏—é –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ</p>
            </div>
            <div class="card-arrow">
              <span v-if="signOutLoading">...</span>
              <span v-else>‚Üí</span>
            </div>
          </button>
        </div>
      </div>

      <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ -->
      <div class="settings-section">
        <h2>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–∫–∫–∞—É–Ω—Ç–µ</h2>
        <div v-if="userInfoLoading" class="loading-info">
          <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏...</p>
        </div>
        <div v-else-if="userInfo" class="account-info">
          <div class="info-item">
            <span class="info-label">ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</span>
            <span class="info-value">{{ userInfo.user_id }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Email:</span>
            <span class="info-value">{{ userInfo.user_email }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</span>
            <span class="info-value">{{ userInfo.user_created_at }}</span>
          </div>
        </div>
        <div v-else class="error-info">
          <p>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ</p>
          <button @click="loadUserInfo" class="retry-button">
            –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
          </button>
        </div>
      </div>
    </div>

    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
    <div v-if="message" :class="['message', messageType]">
      {{ message }}
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted } from "vue";
import { useRouter } from "vue-router";
import { useAuth } from "../composables/useAuth";
import type { User } from "../types/types";

const router = useRouter();
const { signOut, getUserInfo } = useAuth();

const userInfo = ref<User | null>(null);
const userInfoLoading = ref(false);
const signOutLoading = ref(false);
const message = ref("");
const messageType = ref<"success" | "error">("success");

// –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
const loadUserInfo = async () => {
  const token = localStorage.getItem("access_token");
  if (!token) {
    router.push("/auth/signin");
    return;
  }

  userInfoLoading.value = true;
  try {
    const userData = await getUserInfo(token);
    if (userData) {
      userInfo.value = userData;
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º email –≤ localStorage –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö
      localStorage.setItem("user_email", userData.user_email);
    }
  } catch (err) {
    console.error("Error loading user info:", err);
    showMessage("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ", "error");
  } finally {
    userInfoLoading.value = false;
  }
};

// –í—ã—Ö–æ–¥ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞
const handleSignOut = async () => {
  const token = localStorage.getItem("access_token");
  if (!token) {
    router.push("/auth/signin");
    return;
  }

  signOutLoading.value = true;
  try {
    await signOut(token);

    // –û—á–∏—â–∞–µ–º localStorage
    localStorage.removeItem("access_token");
    localStorage.removeItem("refresh_token");
    localStorage.removeItem("user_email");

    // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞
    router.push("/auth/signin");
  } catch (err) {
    console.error("Error during sign out:", err);
    showMessage("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞", "error");
  } finally {
    signOutLoading.value = false;
  }
};

const showMessage = (text: string, type: "success" | "error" = "success") => {
  message.value = text;
  messageType.value = type;
  setTimeout(() => {
    message.value = "";
  }, 3000);
};

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
onMounted(() => {
  loadUserInfo();
});
</script>

<style scoped>
@import url('../styles/pages/settings.css');
</style>
