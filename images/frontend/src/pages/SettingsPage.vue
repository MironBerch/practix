<template>
    <div class="settings-page">
        <div class="settings-header">
            <h1>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–∞</h1>
            <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∞—à–∏–º–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</p>
        </div>

        <div class="settings-content">
            <!-- –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å -->
            <div class="settings-section">
                <h2>–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å</h2>
                <div class="settings-cards">
                    <router-link to="/change-email" class="settings-card">
                        <div class="card-icon">üìß</div>
                        <div class="card-content">
                            <h3>–ò–∑–º–µ–Ω–∏—Ç—å email</h3>
                            <p>–û–±–Ω–æ–≤–∏—Ç–µ –≤–∞—à –∞–¥—Ä–µ—Å —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–π –ø–æ—á—Ç—ã</p>
                        </div>
                        <div class="card-arrow">‚Üí</div>
                    </router-link>

                    <router-link to="/change-password" class="settings-card">
                        <div class="card-icon">üîí</div>
                        <div class="card-content">
                            <h3>–ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</h3>
                            <p>–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –¥–ª—è –≤–∞—à–µ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞</p>
                        </div>
                        <div class="card-arrow">‚Üí</div>
                    </router-link>

                    <router-link to="/sessions" class="settings-card">
                        <div class="card-icon">üíª</div>
                        <div class="card-content">
                            <h3>–ê–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏</h3>
                            <p>–ü—Ä–æ—Å–º–æ—Ç—Ä –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏, –Ω–∞ –∫–æ—Ç–æ—Ä—ã—Ö –≤—ã–ø–æ–ª–Ω–µ–Ω –≤—Ö–æ–¥</p>
                        </div>
                        <div class="card-arrow">‚Üí</div>
                    </router-link>
                </div>
            </div>

            <!-- –î–µ–π—Å—Ç–≤–∏—è -->
            <div class="settings-section">
                <h2>–î–µ–π—Å—Ç–≤–∏—è</h2>
                <div class="settings-cards">
                    <button 
                        @click="handleSignOut"
                        :disabled="signOutLoading"
                        class="settings-card danger"
                    >
                        <div class="card-icon">üö™</div>
                        <div class="card-content">
                            <h3>–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</h3>
                            <p>–ó–∞–≤–µ—Ä—à–∏—Ç–µ —Ç–µ–∫—É—â—É—é —Å–µ—Å—Å–∏—é –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ</p>
                        </div>
                        <div class="card-arrow">
                            <span v-if="signOutLoading">...</span>
                            <span v-else>‚Üí</span>
                        </div>
                    </button>
                </div>
            </div>

            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ -->
            <div class="settings-section">
                <h2>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–∫–∫–∞—É–Ω—Ç–µ</h2>
                <div v-if="userInfoLoading" class="loading-info">
                    <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏...</p>
                </div>
                <div v-else-if="userInfo" class="account-info">
                    <div class="info-item">
                        <span class="info-label">ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</span>
                        <span class="info-value">{{ userInfo.user_id }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Email:</span>
                        <span class="info-value">{{ userInfo.user_email }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</span>
                        <span class="info-value">{{ userInfo.user_created_at }}</span>
                    </div>
                </div>
                <div v-else class="error-info">
                    <p>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ</p>
                    <button @click="loadUserInfo" class="retry-button">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
                </div>
            </div>
        </div>

        <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
        <div v-if="message" :class="['message', messageType]">
            {{ message }}
        </div>
    </div>
</template>

<script setup lang="ts">
    import { ref, onMounted } from 'vue'
    import { useRouter } from 'vue-router'
    import { useAuth } from '../composables/useAuth'
    import type { User } from '../types/types'

    const router = useRouter()
    const { signOut, getUserInfo, loading } = useAuth()

    const userInfo = ref<User | null>(null)
    const userInfoLoading = ref(false)
    const signOutLoading = ref(false)
    const message = ref('')
    const messageType = ref<'success' | 'error'>('success')

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
    const loadUserInfo = async () => {
        const token = localStorage.getItem('access_token')
        if (!token) {
            router.push('/auth/signin')
            return
        }

        userInfoLoading.value = true
        try {
            const userData = await getUserInfo(token)
            if (userData) {
                userInfo.value = userData
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º email –≤ localStorage –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö
                localStorage.setItem('user_email', userData.user_email)
            }
        } catch (err) {
            console.error('Error loading user info:', err)
            showMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ', 'error')
        } finally {
            userInfoLoading.value = false
        }
    }

    // –í—ã—Ö–æ–¥ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞
    const handleSignOut = async () => {
        const token = localStorage.getItem('access_token')
        if (!token) {
            router.push('/auth/signin')
            return
        }

        signOutLoading.value = true
        try {
            await signOut(token)
            
            // –û—á–∏—â–∞–µ–º localStorage
            localStorage.removeItem('access_token')
            localStorage.removeItem('refresh_token')
            localStorage.removeItem('user_email')
            
            // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞
            router.push('/auth/signin')
        } catch (err) {
            console.error('Error during sign out:', err)
            showMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞', 'error')
        } finally {
            signOutLoading.value = false
        }
    }

    const showMessage = (text: string, type: 'success' | 'error' = 'success') => {
        message.value = text
        messageType.value = type
        setTimeout(() => {
            message.value = ''
        }, 3000)
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
    onMounted(() => {
        loadUserInfo()
    })
</script>

<style scoped>
    .settings-page {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
    }

    .settings-header {
        text-align: center;
        margin-bottom: 40px;
    }

    .settings-header h1 {
        margin: 0 0 10px 0;
        color: #333;
        font-size: 2.5em;
    }

    .settings-header p {
        margin: 0;
        color: #666;
        font-size: 1.1em;
    }

    .settings-content {
        display: flex;
        flex-direction: column;
        gap: 40px;
    }

    .settings-section h2 {
        margin: 0 0 20px 0;
        color: #333;
        font-size: 1.5em;
        border-bottom: 2px solid #f0f0f0;
        padding-bottom: 10px;
    }

    .settings-cards {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .settings-card {
        display: flex;
        align-items: center;
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 12px;
        padding: 20px;
        text-decoration: none;
        color: inherit;
        transition: all 0.3s ease;
        cursor: pointer;
        gap: 15px;
    }

    .settings-card:hover {
        border-color: #3498db;
        box-shadow: 0 4px 15px rgba(52, 152, 219, 0.1);
        transform: translateY(-2px);
        text-decoration: none;
        color: inherit;
    }

    .settings-card.danger:hover {
        border-color: #e74c3c;
        box-shadow: 0 4px 15px rgba(231, 76, 60, 0.1);
    }

    .settings-card:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .settings-card:disabled:hover {
        border-color: #e0e0e0;
        box-shadow: none;
        transform: none;
    }

    .card-icon {
        font-size: 24px;
        width: 50px;
        height: 50px;
        background: #f8f9fa;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .card-content {
        flex: 1;
    }

    .card-content h3 {
        margin: 0 0 5px 0;
        color: #333;
        font-size: 1.2em;
        font-weight: 600;
    }

    .card-content p {
        margin: 0;
        color: #666;
        font-size: 0.95em;
        line-height: 1.4;
    }

    .card-arrow {
        color: #999;
        font-size: 1.2em;
        font-weight: bold;
    }

    .account-info {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 25px;
    }

    .info-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #e9ecef;
    }

    .info-item:last-child {
        border-bottom: none;
    }

    .info-label {
        font-weight: 600;
        color: #333;
    }

    .info-value {
        color: #666;
        font-family: 'Courier New', monospace;
        word-break: break-all;
    }

    .loading-info {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 40px;
        text-align: center;
        color: #666;
    }

    .error-info {
        background: #fdf2f2;
        border: 1px solid #f5c6cb;
        border-radius: 12px;
        padding: 30px;
        text-align: center;
        color: #721c24;
    }

    .error-info p {
        margin: 0 0 15px 0;
    }

    .retry-button {
        background: #3498db;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }

    .retry-button:hover {
        background: #2980b9;
    }

    .message {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 8px;
        color: white;
        font-weight: 600;
        z-index: 1000;
        max-width: 300px;
    }

    .message.success {
        background: #27ae60;
    }

    .message.error {
        background: #e74c3c;
    }

    @media (max-width: 768px) {
        .settings-page {
            padding: 15px;
        }

        .settings-header h1 {
            font-size: 2em;
        }

        .settings-card {
            padding: 15px;
        }

        .card-icon {
            width: 40px;
            height: 40px;
            font-size: 20px;
        }

        .info-item {
            flex-direction: column;
            align-items: flex-start;
            gap: 5px;
        }

        .info-value {
            word-break: break-all;
        }
    }

    @media (max-width: 480px) {
        .settings-header h1 {
            font-size: 1.8em;
        }

        .settings-card {
            flex-direction: column;
            text-align: center;
            gap: 12px;
        }

        .card-content h3 {
            font-size: 1.1em;
        }
    }
</style>
